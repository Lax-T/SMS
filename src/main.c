/**
  ******************************************************************************
  * @file    main.c
  * @author  Ac6
  * @version V1.0
  * @date    01-December-2013
  * @brief   Default main function.
  ******************************************************************************
*/
#include "FreeRTOS.h"
#include "task.h"
#include "queue.h"
#include <drivers/led_driver.h>
#include <drivers/UC1608X_driver.h>
#include <ui/fonts.h>
#include "stm32f2xx.h"
#include "main.h"
#include "init.h"
#include "tasks/system.h"
#include "ui/glib.h"
#include "ui/icons.h"
#include "globals.h"
#include <tasks/ui_control.h>
#include "ui/led_control.h"
#include "delays.h"
#include "tasks/slow_bus_master.h"
#include "misc/task_messaging.h"
			

QueueHandle_t xUIQueue;


int main(void)
{
	u8 clk_status = clkInit();
	init();
	if (clk_status == 0) {
		mSLED_GREEN_ON;
	} else {
		mSLED_GREEN_OFF;
	}

	mBTN_SYNC_135_ON;
	mLDR_CLK_LO;
	mLDR_DATA_LO;
	mLDR_LAT_LO;

/*
	static u8 tile[] = {0x09, 0x10, 0x00, 0x00, 0x00, 0x22, 0x22, 0x22, 0xff, 0x22, 0x44, 0xff, 0x44, 0x44, 0x44, 0x00,
			0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};

	static u8 tile_72[] = {0x09, 0x10, 0x00, 0x00, 0x00, 0x41, 0x41, 0x41, 0x41, 0x7f, 0x41, 0x41, 0x41, 0x41, 0x41, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
	static u8 tile_101[] = {0x09, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1e, 0x23, 0x41, 0x7f, 0x40, 0x60, 0x1f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
	static u8 tile_108[] = {0x09, 0x10, 0x00, 0x00, 0x70, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x7e, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
	static u8 tile_111[] = {0x09, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1e, 0x23, 0x41, 0x41, 0x41, 0x62, 0x3c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
	static u8 tile_30[] = {0x09, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
	static u8 tile_119[] = {0x09, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x41, 0x41, 0x49, 0x55, 0x55, 0x55, 0x62, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
	static u8 tile_114[] = {0x09, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x2e, 0x31, 0x21, 0x20, 0x20, 0x20, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
	static u8 tile_100[] = {0x09, 0x10, 0x00, 0x00, 0x02, 0x02, 0x02, 0x02, 0x1e, 0x22, 0x42, 0x42, 0x42, 0x66, 0x3a, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};

	static u8 *hello_world[] = {tile_72, tile_101, tile_108, tile_108, tile_111, tile_30, tile_119, tile_111, tile_114, tile_108, tile_100};
*/
	/* MOVED TO UI TASK
	uc_initController();
	gl_clearBuffer();
	*/
	//gl_setCursor(0, 0);
	//gl_mergeTile(tile);
	/*
	u8 i;
	u8** font;
	u8 chr;
	font = fnt_getFont(ARIAL_12PTB);
	const char *text = "SMS Gen.2";
	for (i = 0; i < 9; i++ ) {
		gl_setCursor(i * 9, 0);
		//gl_mergeTile(hello_world[i]);
		chr = text[i];
		gl_mergeTile(font[chr]);
	}

	text = "GLCD test...";
	for (i = 0; i < 12; i++ ) {
		gl_setCursor(i * 9, 16);
		//gl_mergeTile(hello_world[i]);
		chr = text[i];
		gl_mergeTile(font[chr]);
	}*/

	/*
	gl_setCursor(0, 0);
	gl_printString("SMS Gen.2", CONSOLAS_11PT);

	gl_setCursor(0, 18);
	gl_printString("GLCD test...", ARIAL_12PTB);

	gl_setCursor(0, 36);
	gl_printString("1234", DIGITAL_25PX);

	gl_setCursor(0, 70);
	gl_printString("1358.", DIGITAL_44PX);

	gl_setCursor(0, 120);
	gl_printString("0123456", DIGITAL_19PX);

	gl_setCursor(105, 122);
	gl_mergeTile(ico_getIcon(ICO_DEGREE_C15));

	gl_setCursor(0, 142);
	gl_drawHLine(1, 128);

	gl_setCursor(0, 147);
	gl_printString("TVOC  ppb", ARIAL_10PTB);

	gl_setCursor(0, 162);
	gl_printString("AIRPr  mm %", ARIAL_10PTB);

	gl_setCursor(4, 180);
	gl_drawHLine(3, 5);

	//Formatted string test
	gl_setCursor(0, 185);
	gl_printFString("AIRPr %06uc", 2, ARIAL_10PTB);
	gl_setCursor(0, 200);
	s8 s = -2;
	gl_printFString("AIRPr %sc", &s, ARIAL_10PTB);
	gl_setCursor(0, 215);
	float f = 14.897;
	gl_printFString("AIRPr %.3f", &f, ARIAL_10PTB);

	gl_refreshLCD();*/

	/*uc_setWriteAddress(0, 0);
	uc_writeSingle(0xFF);
	uc_setWriteAddress(2, 20);
	uc_writeSingle(0xFF);
	uc_writeSingle(0xFF);
	uc_setWriteAddress(4, 50);
	uc_writeSingle(0xFF);
	uc_writeSingle(0xFF);
	uc_writeSingle(0xFF);

	uc_setWriteAddress(4, 55);
	uc_writeSingle(0xF7);
	uc_writeSingle(0xF7);
	uc_writeSingle(0xF7);
	uc_writeSingle(0x07);
	uc_writeSingle(0xF7);
	uc_writeSingle(0xF7);*/

	/* MOVED TO UI TASK
	uc_lcdOn();

	lc_init();
	lc_setBacklightGroupValue(10);

	lc_setAmbientBrt(2);
	lc_setAmbientGroupValue(240, 120, 2);

	lc_setSecondBrt(20);
	lc_setSecondValue(0);

	lc_setTimeBrt(60);
	lc_setTimeValue(12, 24);

	lc_refresh();
	*/

	//mSLED_RED_ON;
	//ldr_testRun();

	/* Create queues */
	xUIQueue = xQueueCreate(10, sizeof(struct StandardQueueMessage));

	/* Initialize tasks (threads) */
	xTaskCreate(uic_taskUIControl, "UI ctrl", 256, NULL, 1, NULL);
	xTaskCreate(sbm_taskSlowBusMaster, "Slow I2C", 256, NULL, 1, NULL);
	//xTaskCreate(sys_taskSystem, "System", 128, NULL, 1, NULL);
	vTaskStartScheduler();
	/*
	u8 sec = 0;
	u8 min = 34;
	u8 hour = 12;
	*/

	while(1) {
		mSDelay(1200);
		/* MOVED TO UI TASK
		sec++;
		if (sec >= 60) {
			sec = 0;
			min++;
			if (min >= 60) {
				min = 0;
				hour++;
				if (hour >= 24) {
					hour = 0;
				}
			}
		}
		lc_setSecondValue(sec);
		lc_setTimeValue(hour, min);
		lc_refresh();
		*/

		if (mBTN_IN_OK) {
			mSLED_RED_ON;
		} else {
			mSLED_RED_OFF;
		}
	}
}
